{% extends "base.html" %}
{% block title %}History ¬∑ Subtopic Explorer{% endblock %}
{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between gap-3 mb-4">
  <div>
    <h1 class="h3 mb-1">Generation history</h1>
    <p class="text-muted mb-0">Browse, search, and curate every topic map you have created.</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" href="{{ url_for('main.dashboard') }}">New generation</a>
    {% if entries %}
    <a class="btn btn-outline-secondary" href="{{ url_for('main.export_history') }}">Export all</a>
    <form method="post" action="{{ url_for('main.clear_history') }}" onsubmit="return confirm('Clear all saved history? This cannot be undone.');">
      <button type="submit" class="btn btn-outline-danger">Clear history</button>
    </form>
    {% endif %}
  </div>
</div>

<form class="row gy-2 gx-3 align-items-center mb-4" method="get" action="{{ url_for('main.history') }}">
  <div class="col-sm-6 col-lg-4">
    <label class="visually-hidden" for="history-search">Search topics</label>
    <div class="input-group">
      <span class="input-group-text">üîç</span>
      <input type="search" class="form-control" id="history-search" name="q" placeholder="Search topics or subtopics" value="{{ query }}">
    </div>
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary">Search</button>
  </div>
  {% if query %}
  <div class="col-auto">
    <a class="btn btn-link" href="{{ url_for('main.history') }}">Clear filter</a>
  </div>
  {% endif %}
  <div class="col-lg ms-lg-auto text-muted small">
    Showing {{ filtered_count }} of {{ total_count }} saved runs.
  </div>
</form>

{% if favorites %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h2 class="card-title h5 mb-3">Pinned favorites</h2>
    <div class="d-flex flex-wrap gap-2">
      {% for entry in favorites %}
        <a href="{{ url_for('main.view_history_entry', entry_id=entry['id']) }}" class="badge bg-warning text-dark text-decoration-none">‚òÖ {{ entry['topics']|join(', ') }}</a>
      {% endfor %}
    </div>
    <p class="text-muted small mb-0 mt-3">Use the star button in the table below to pin or unpin topic maps.</p>
  </div>
</div>
{% endif %}

{% if entries %}
<div class="table-responsive">
  <table class="table align-middle">
    <thead>
      <tr>
        <th scope="col" class="text-center">‚òÖ</th>
        <th scope="col">Topics</th>
        <th scope="col">Depth</th>
        <th scope="col">Nodes</th>
        <th scope="col">Model</th>
        <th scope="col">Mode</th>
        <th scope="col">Created</th>
        <th scope="col" class="text-end"></th>
      </tr>
    </thead>
    <tbody>
      {% for entry in entries %}
      <tr class="{% if entry.get('is_favorite') %}table-warning{% endif %}">
        <td class="text-center">
          <form method="post" action="{{ url_for('main.toggle_favorite', entry_id=entry['id']) }}">
            <input type="hidden" name="value" value="{{ '0' if entry.get('is_favorite') else '1' }}">
            <input type="hidden" name="next" value="{{ request.full_path | default(request.path) }}">
            <button type="submit" class="btn btn-link p-0 align-baseline favorite-toggle" aria-label="Toggle favorite">
              {% if entry.get('is_favorite') %}‚òÖ{% else %}‚òÜ{% endif %}
            </button>
          </form>
        </td>
        <td>{{ entry['topics']|join(', ') }}</td>
        <td>{{ entry['max_level'] }}</td>
        <td>{{ entry.get('summary', {}).get('total_nodes', '‚Äî') }}</td>
        <td>{{ entry['model'] }}</td>
        <td>
          {% if entry['use_demo_mode'] %}
            <span class="badge bg-secondary">Demo</span>
          {% else %}
            <span class="badge bg-success">Live</span>
          {% endif %}
        </td>
        <td>{{ entry['created_at']|format_datetime }}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm" role="group">
            <a class="btn btn-outline-secondary" href="{{ url_for('main.download_history_entry', entry_id=entry['id']) }}">JSON</a>
            <a class="btn btn-outline-primary" href="{{ url_for('main.view_history_entry', entry_id=entry['id']) }}">Open</a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
  <div class="text-center text-muted py-5">
    <p class="lead">No saved generations yet.</p>
    <p><a href="{{ url_for('main.dashboard') }}" class="btn btn-primary">Create your first topic map</a></p>
  </div>
{% endif %}
{% endblock %}
